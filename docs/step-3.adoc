= Hands-on #3. Developing shopping cart.
:experimental:
:icons: font
:idprefix:
:idseparator: -
:imagesdir: step-3
:nbsp:
:sectanchors:
:sectlinks:
:sectnums:
:source-highlighter: prettify
:toc:

== Implementing ShoppingCartService

. Generate new service with following Angular CLI command:
+
[source, shell]
----
$ ng generate service shared/services/shopping-cart --spec false
----

. Re-export `ShoppingCartService` from _src/app/shared/services/index.ts_ file:
+
[source, ts]
----
export * from './shopping-cart.service';
----

. Replace content of the _shopping-cart.service.ts_ file with the following code:
+
[source, ts]
----
import { Injectable } from '@angular/core';

interface ShoppingCartState {
  [key: string]: number;
}

const SHOPPING_CART_KEY = 'ngs_shopping_cart';

@Injectable()
export class ShoppingCartService {

  private state: ShoppingCartState;

  constructor() {
    this.state = this.loadState() || {};
  }

  get totalQuantity(): number {
    return Object.keys(this.state).reduce((total, productId) => {
      return total + this.state[productId];
    }, 0);
  }

  getItems(): ShoppingCartState {
    // Return a copy of the shopping cart's state.
    return Object.assign({}, this.state);
  }

  setItems(items: ShoppingCartState): void {
    this.state = items;
    this.saveState();
  }

  addItem(productId: string, quantity: number): void {
    if (quantity > 0) {
      this.state[productId] = (this.state[productId] || 0) + quantity;
      this.saveState();
    }
  }

  removeItem(productId: string): void {
    delete this.state[productId];
    this.saveState();
  }

  setQuantity(productId: string, quantity: number): void {
    if (quantity > 0) {
      this.state[productId] = quantity;
      this.saveState();
    } else {
      this.removeItem(productId);
    }
  }

  private loadState(): ShoppingCartState {
    return JSON.parse(localStorage.getItem(SHOPPING_CART_KEY));
  }

  private saveState(): void {
    localStorage.setItem(SHOPPING_CART_KEY, JSON.stringify(this.state));
  }
}
----

. Add `ShoppingCartService` to the list of `AppModule` providers in the _src/app/app.module.ts_ file:
+
[source, ts]
----
import { ProductService, ShoppingCartService } from './shared/services'; // <1>

@NgModule({
  // Module declarations, imports go here...
  providers: [ ProductService ], // <1>
  bootstrap: [ AppComponent ]
})
export class AppModule {}
----
<1> Add service to the import statement.
<2> Add `ShoppingCartService` to the list of `AppModule` providers.

. Commit the changes to save the progress:
+
[source, shell]
----
$ git add -A && git commit -m "Add shopping cart service"
----

== Generating and configuring routing for CartComponent

. Generate component that will represent shopping cart page using following Angular CLI command:
+
[source, shell]
----
$ ng generate component cart --spec false
----

. Generate class that will resolve data before shopping cart is rendered using following Angular CLI command:
+
[source, ts]
----
ng generate class cart/cart.resolver --spec false
----

. Replace content of the _src/app/cart/cart.resolver.ts_ file with following code:
+
[source, ts]
----
import { Injectable } from '@angular/core';
import { Resolve } from '@angular/router';
import { Observable } from 'rxjs/Observable';
import 'rxjs/add/observable/forkJoin';

import {
  Product,
  ProductService,
  ShoppingCartService
} from '../shared/services';

@Injectable()
export class CartResolver implements Resolve<Product[]> {

  constructor(private productService: ProductService,
              private shoppingCartService: ShoppingCartService) {}

  resolve(): Observable<Product[]> {
    // Get IDs of all products in the shopping cart.
    const productsInCart = Object.keys(this.shoppingCartService.getItems());

    // Create an array of lazy HTTP requests. Each request fetches a product.
    const requests = productsInCart.map(productId =>
        this.productService.getProductById(productId));

    // Create an observable that emits the result when all the requests
    // successfully complete.
    return requests.length ? Observable.forkJoin(requests) : Observable.of([]);
  }
}
----

. Create _index.ts_ file inside _src/app/cart_ directory with the following code:
+
[source, ts]
----
export * from './cart.component';
export * from './cart.resolver';
----

. In _src/app/app.routing.ts_ file add import statements for `CartComponent` and `CartResolver` classes,
add one more path configuration for the shopping cart page:
+
[source, ts]
----
import { CartComponent, CartResolver } from './cart';

export const routes: Route[] = [
  // Rest of the routing configuration...
  { path: 'cart',
    component: CartComponent,
    resolve: {
      products: CartResolver
    }
  }
];
----

. In _src/app/app.module.ts_ file add import statement for `CartResolver` and add it to the providers list of `AppModule`:
+
[source, ts]
----
import { CartComponent, CartResolver } from './cart';

@NgModule({
  // Module imports, declarations...
  providers: [
    CartResolver,
    // Rest of the providers...
  ],
  bootstrap: [ AppComponent ]
})
export class AppModule {}
----

. Start the application with `ng serve` command, open a web browser, enter `http://localhost:4200/cart` URL, you should see the default component's message:
+
.Shopping cart page
image::fig_01.png[Shopping cart page,424,role="thumb"]

. Commit the changes to save the progress:
+
[source, shell]
----
$ git add -A && git commit -m "Generate cart component, add resolver, configure router"
---

== Implementing CartComponent

== Making add-to-cart button work on product page

== Adding shopping cart icon button to the toolbar


////
TODO:
* Add toast notification on the product page
////
