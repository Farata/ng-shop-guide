= Hands-on #1. Developing Home page.
:experimental:
:icons: font
:idprefix:
:idseparator: -
:imagesdir: step-1
:nbsp:
:sectanchors:
:sectlinks:
:sectnums:
:source-highlighter: prettify
:toc:

== Bootstrapping the project

. _Optionally._ If you have yarn installed, specify it as the default Angular CLI package manager
+
[source, shell]
----
$ ng set --global packageManager=yarn
----

. Generate new project:
+
[source, shell]
----
$ ng new ng-shop --prefix ngs --style scss
----

. Add Angular Material to the project with one of the two following commands:
+
[source, shell]
----
# EITHER with yarn:
$ yarn add @angular/material -E           # <1>
# OR with npm:
$ npm install @angular/material --save -E # <1>
----
<1> `-E` denotes _exact_ version of the package with no http://semver.org/[semver] range operators applied.

. Add a prebuilt Angular Material theme to the _src/styles.css_ file:
+
[source, scss]
----
@import '~@angular/material/core/theming/prebuilt/indigo-pink.css';
----

. Add `MaterialModule` to the imports section of the `AppModule` in the _src/app/app.module.ts_ file:
+
[source, ts]
----
import { MaterialModule } from '@angular/material'; // <1>

@NgModule({
  declarations: [ AppComponent ],
  imports: [
    // Other modules...
    MaterialModule // <2>
  ],
  // Providers and bootstrap component...
})
export class AppModule {}
----

. Add the toolbar component in _src/app/app.component.html_:

. Launch the development server with `ng serve` command and open the app in a Web browser to make sure Angular Material is properly configured. You should be able to see a page with a default grey toolbar with the NgShop text aligned on the left:
+
.Angular Material Toolbar
image::fig_01.png[Toolbar,361,203,role="thumb"]

. Commit the changes to save the progress:
+
[source, shell]
----
$ git add -A && git commit -m "Add Angular Material package"
----

== Configuring custom Angular Material theme

. Create the directory _src/styles_:
+
[source, shell]
----
$ mkdir src/styles
----

. Move _src/styles.css_ file to the just created directory:
+
[source, shell]
----
$ mv src/styles.scss src/styles/styles.scss
----

. Create __palette.scss_ and _theme.scss_ files in the _src/styles_ folder:
+
[source, shell]
----
$ touch src/styles/_palette.scss
$ touch src/styles/theme.scss
----

. Put the styles below to the __palette.scss_ file:
+
[source, scss]
----
@import '~@angular/material/core/theming/theming';

// Define the palettes for your theme using the Material Design palettes
// available in palette.scss (imported above). For each palette, you can
// optionally specify a default, lighter, and darker hue.
$ngs-primary: mat-palette($mat-cyan);
$ngs-accent:  mat-palette($mat-cyan, A200, A100, A400);
$ngs-warn:    mat-palette($mat-red);

// Create the theme object (a Sass map containing all of the palettes).
$ngs-theme: mat-light-theme($ngs-primary, $ngs-accent, $ngs-warn);

$ngs-background: map-get($ngs-theme, background);
$ngs-foreground: map-get($ngs-theme, foreground);

$ngs-brand-font: 'Abril Fatface', cursive;
----

. Put the styles below to the _theme.scss_ file:
+
[source, scss]
----
@import url('https://fonts.googleapis.com/css?family=Abril+Fatface');
@import url('https://fonts.googleapis.com/icon?family=Material+Icons');
@import '~@angular/material/core/theming/all-theme';
@import './palette';

// Include the base styles for Angular Material core. We include this here so
// that you only have to load a single CSS file for Angular Material in your app.
@include mat-core();

// Include theme styles for core and each component used in your app.
// Alternatively, you can import and @include the theme mixins for each component
// that you are using.
@include angular-material-theme($ngs-theme);

md-ink-bar {
  background-color: mat-color($ngs-accent);
}

body {
  color: mat-color($ngs-foreground, text);
  font-family: $mat-font-family;
  font-size: rem(1.4);
}
----

. Replace content of the __styles.scss__ file:
+
[source, scss]
----
body {
  margin: 0;
  padding: 0;
  height: 100%;
}
----

. Change value of the `apps[0].styles` array in the _.angular-cli.json_ file, it should list _styles.scss_ and _theme.scss_ files:
+
[source, json]
----
"styles": [
  "styles/styles.scss",
  "styles/theme.scss"
]
----

. Restart development web server with kbd:[Ctrl+C] and `ng serve` to apply changes in _.angular-cli.json_ file.

. To make sure the theme is properly configured try to set attribute `color="primary"` for the `<md-toolbar>` element in the _src/app/app.component.html_ file. Open the app in a web browser you should see the toolbar with cyan background:
+
.Toolbar with cyan background
image::fig_02.png[Toolbar with cyan background,417,role="thumb"]
+
Remove `color="primary"` now since the background color of the toolbar in our application will be white.

. Now let's add the permanent version of toolbar that we'll be using in the app. First, copy _ngshop-logo.svg_ image from the handouts to the _src/assets_ folder:
+
[source, shell]
----
$ cp {path-to-handouts}/ngshop-logo.svg src/assets
----

. Replace content of the _src/app/app.component.html_ file with the following HTML markup:
+
[source, html]
----
<md-toolbar>
  <span class="fill"></span>
  <img class="logo" src="assets/ngshop-logo.svg" alt="NgShop Logo">
  <span class="fill"></span>
</md-toolbar>
----

. Replace content of the _src/app/app.component.scss_ files with following styles:
+
[source, scss]
----
@import '../styles/palette';

md-toolbar {
  background: mat-color($ngs-background, card);

  // This adds a bottom border. On the home page the tabs are rendered on top of the
  // shadow this makes the header look like a single component. On other pages, the
  // shadow is visible, so it separates header from the content.
  box-shadow: 0 1px mat-color($ngs-foreground, divider);
}

.fill {
  flex: 1 1 auto;
}

.logo {
  height: 36px;
  width: auto;
}
----
+
After applying the changes to `AppComponent` the application should look like this:
+
.Complete toolbar
image::fig_03.png[Complete toolbar,489,role="thumb"]

. Commit the changes to save the progress:
+
[source, shell]
----
$ git add -A && git commit -m "Add custom Angular Material theme"
----

== Adding static NgShop data

. Copy _data_ directory from the class handouts to the _src_ directory of NgShop project:
+
[source, shell]
----
$ cp -r {path-to-handouts}/data src
----

. Add `"data"` string to the the `apps[0].assets` array in the _.angular-cli.json_ file:
+
[source, json]
----
"assets": [
  "assets",
  "data",
  "favicon.ico"
],
----

. Restart development web server with kbd:[Ctrl+C] and `ng serve` to apply changes in _.angular-cli.json_ file.

. Commit the changes to save the progress:
+
[source, shell]
----
$ git add -A && git commit -m "Add static NgShop data"
----

== Implementing ProductService

. Create _src/app/shared/services_ directory:
+
[source, shell]
----
$ mkdir -p src/app/shared/services
----

. Generate the service with Angular CLI in the just created folder:
+
[source, shell]
----
$ ng generate service shared/services/product --spec false # <1>
# Shorthand: ng g s shared/services/product -spec false
----
<1> Note the specified path is relative to the _src/app_ directory.
+
Here is the command's output:
+
.Generate service command output
image::fig_04.png[Generate service command output,878,role="thumb"]

. Create _index.ts_ file in the _src/app/shared/services/product_ folder, put following code in there:
+
[source, ts]
----
export * from './product.service';
----

. Replace content of the _product.service.ts_ file with the following code:
+
[source, ts]
----
import { Injectable } from '@angular/core';
import { Http } from '@angular/http';
import { Observable } from 'rxjs/Observable';
import 'rxjs/add/operator/map';

@Injectable()
export class ProductService {

  constructor(private http: Http) {}

  getAll(): Observable<Product[]> {
    return this.http.get('/data/products/all.json')
      .map(resp => resp.json());
  }
}

export interface Product {
  description: string;
  featured: boolean;
  imageUrl: string;
  price: number;
  title: string;
  id: string;
}
----

. Add `ProductService` to the list of `AppModule` providers in the _src/app/app.module.ts_ file:
+
[source, ts]
----
import { ProductService } from './shared/services'; // <1>

@NgModule({
  // Module declarations, imports go here...
  providers: [ ProductService ], // <2>
  bootstrap: [ AppComponent ]
})
export class AppModule {}
----
<1> Because of we created _src/app/shared/services/index.ts_ file we can use a shorter path here.
<2> Add `ProductService` here.

. To make sure the service is created properly try injecting into `AppComponent`, invoke `getAll()` method, and print result of the request into the console:
+
[source, ts]
----
import { ProductService } from './shared/services';

@Component({...})
export class AppComponent {
  constructor(productService: ProductService) {
    productService.getAll()                            // <1>
        .subscribe(products => console.log(products)); // <2>
  }
}
----
<1> Since observables are lazy `getAll()` doesn't trigger HTTP request immediately, it waits till someone subscribes to it.
<2> When the data arrives, print it to the console.
+
Launch the development web server, open the application in a web browser and take a look at the dev console, you should see an array of product objects printed there.
+
Remove `ProductService` from `AppComponent` since it won't be responsible for displaying products.

. Commit the changes to save the progress:
+
[source, shell]
----
$ git add -A && git commit -m "Add initial version of ProductService"
----

== Adding the Home page

=== Fetching products from the server, implementing grid list layout
. Generate new component using Angular CLI:
+
[source, shell]
----
$ ng generate component home --spec false
----
+
.Generate component command output
image::fig_05.png[Generate component command output,460,role="thumb"]

. Create _index.ts_ file inside _src/app/home_ directory with the following code:
+
[source, ts]
----
export * from './home.component';
----
+
Now you can simplify the import statement for `HomeComponent` in _src/app/app.module.ts_ file:
+
[source, ts]
----
import { HomeComponent } from './home'; // instead of './home/home.component'
----

. Add `HomeComponent` to the `AppComponent`{nbsp}'s template:
+
[source, html]
----
<md-toolbar>
  <!-- Toolbar's content here... -->
</md-toolbar>

<ngs-home></ngs-home> <!--1-->
----
<1> The line you need to add.
+
Now you should see home component rendered in the browser:
+
.Home component rendered on the page
image::fig_06.png[Home component rendered on the page,425,role="thumb"]

. Replace content of the _src/app/home/home.component.ts_ file with the following code:
+
[source, ts]
----
import { Component } from '@angular/core';
import { Observable } from 'rxjs/Observable';
import { Product, ProductService } from '../shared/services';

@Component({
  selector: 'ngs-home',
  styleUrls: [ './home.component.scss' ],
  templateUrl: './home.component.html'
})
export class HomeComponent {
  products: Observable<Product[]>;
  constructor(private productService: ProductService) {
    this.products = this.productService.getAll();
  }
}
----

. Replace content of the _src/app/home/home.component.html_ file with the following HTML markup:
+
[source, html]
----
<div class="grid-list-container">
  <md-grid-list cols="3" gutterSize="16">
    <md-grid-tile *ngFor="let p of products | async">
      {{ p.title }}
    </md-grid-tile>
  </md-grid-list>
</div>
----

. Replace content of the _src/app/home/home.component.scss_ file with the following styles:
+
[source, scss]
----
:host {
  display: block;
  background: #f3f3f3;
}

.grid-list-container {
  padding: 16px;
}
----
+
Now the page should look like this:
+
.Grid list layout
image::fig_07.png[Grid list layout,516,role="thumb"]

. Commit the changes to save the progress:
+
[source, shell]
----
$ git add -A && git commit -m "Add HomeComponent, display products in the grid list layout"
----

=== Adding product tiles

. Generate new component using Angular CLI:
+
[source, shell]
----
$ ng generate component home/product-tile --spec false
----
+
Re-export `ProductTileComponent` from the _src/app/home/index.ts_ file:
+
[source, ts]
----
export * from './product-tile/product-tile.component';
----
+
Simplify generated import statement for the _ProductTileComponent_ in the _src/app/app.module.ts_ file:
+
[source, ts]
----
// Instead of this:
// import { ProductTileComponent } from './home/product-tile/product-tile.component';

// Use this:
import { HomeComponent, ProductTileComponent } from './home';
----

. Replace content of the _product-tile.component.ts_ file with the following code:
+
[source, ts]
----
import { Component, Input } from '@angular/core';
import { Product } from '../../shared/services';

@Component({
  selector: 'ngs-product-tile',
  styleUrls: [ './product-tile.component.scss' ],
  templateUrl: './product-tile.component.html'
})
export class ProductTileComponent {
  @Input() product: Product;
}
----

. Replace content of the _product-tile.component.html_ file with the following HTML markup:
+
[source, ts]
----
<div class="thumbnail" [ngStyle]="{'background-image': 'url(' + product.imageUrl + ')'}"></div>
<div class="title">{{ product.title }}</div>
----

. Replace content of the _product-tile.component.scss_ file with the following styles:
+
[source, scss]
----
@import '~@angular/material/core/style/variables';
@import '../../../styles/palette';

:host {
  background: mat-color($ngs-background, card);
  height: 100%;
  width: 100%;
  padding: 8px;
  text-align: center;

  // Children layout
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
}

.thumbnail {
  background: no-repeat 50% 50%;
  background-size: contain;
  height: 50%;
  width: 50%;
}

.title {
  color: mat-color($ngs-foreground, text);
  font-family: $ngs-brand-font;
  font-size: 34px; // Display 1

  @media ($mat-small) {
    font-size: 24px; // Headline
  }

  @media ($mat-xsmall) {
    font-size: 20px; // Title
  }
}
----

. Open _home.component.html_ file and replace data binding expression `{{ p.title }}` with the product tile component:
+
[source, html]
----
<ngs-product-tile [product]="p"></ngs-product-tile>
----
+
Now your home page should look like this:
+
[[figure-8]]
.Home page with product tiles
image::fig_08.png[Home page with product tiles,1131,role="thumb"]

. Commit the changes to save the progress:
+
[source, shell]
----
$ git add -A && git commit -m "Add product tiles on the home page"
----

=== Adding category tabs

. Add `categories` array as the `HomeCompoent`{nbsp}'s property that lists all available categories:
+
[source, ts]
----
@Component({...})
export class HomeComponent {
  private readonly categories = [
    'all',
    'featured',
    'latest',
    'sport'
  ];
  // Rest of the class definition...
}
----

. Add `MdTabGroup` component at the very top of the home component's template. It should render individual `MdTab`{nbsp}s while looping over `categories` array with `*ngFor` directive:
+
[source, html]
----
<md-tab-group>
  <md-tab *ngFor="let c of categories" [label]="c | uppercase"></md-tab>
</md-tab-group>
----

. Add styles for the tab group in _home.component.scss_ file:
+
[source, scss]
----
@import '../../styles/palette';

md-tab-group {
  background: mat-color($ngs-background, card);
}
----
+
Now the home page in a web browser should look like this:
+
.Category tabs on the home page
image::fig_09.png[Category tabs on the home page,933,role="thumb"]

=== Making category tabs interactive

. Add `getCategory()` method to the `ProductService` class:
+
[source, ts]
----
@Injectable()
export class ProductService {
  // Rest of the class definition...

  getCategory(category: string): Observable<Product[]> {
    return this.http.get(`/data/products/${category}.json`)
      .map(resp => resp.json());
  }
}
----

. In `HomeComponent`{nbsp}'s template add event binding for the `selectedIndexChange` event:
+
[source, ts]
----
<md-tab-group (selectedIndexChange)="onTabChange($event)"> <!--1-->
----
<1> `$event` variable carries the index number of currently activated tab.

. Implement `onTabChange()` method in `HomeComponent`:
+
[source, ts]
----
@Component({...})
export class HomeComponent {
  // Rest of the class definition...

  onTabChange(tabIndex: number) {
    const category = this.categories[tabIndex];
    this.products = this.productService.getCategory(category);
  }
}
----
+
// TODO: Add "to make sure" step.

. Commit the changes to save the progress:
+
[source, shell]
----
$ git add -A && git commit -m "Make categories tabs interactive"
----

== Adding extra features

=== Using MdIcon for NgShop Logo

. Replace content of the _src/app/app.component.ts_ with the following code:
+
[source, ts]
----
import { Component } from '@angular/core';
import { DomSanitizer } from '@angular/platform-browser';
import { MdIconRegistry } from '@angular/material';

@Component({
  selector: 'ngs-app',
  styleUrls: [ './app.component.scss' ],
  templateUrl: './app.component.html',
})
export class AppComponent {

  constructor(
      private domSanitizer: DomSanitizer,
      private iconRegistry: MdIconRegistry) {
    this.registerIcons(new Map<string, string>([
      [ 'logo', 'assets/ngshop-logo.svg' ]
    ]));
  }

  private registerIcons(icons: Map<string, string>) {
    icons.forEach((url, id) => {
      const safeUrl = this.domSanitizer.bypassSecurityTrustResourceUrl(url);
      this.iconRegistry.addSvgIconInNamespace('ngs', id, safeUrl);
    });
  }
}
----

. In the _app.component.html_ file replace `<img>` element with `MdIcon` component:
+
[source, html]
----
<md-icon class="logo" svgIcon="ngs:logo"></md-icon>
----

. Commit the changes to save the progress:
+
[source, shell]
----
$ git add -A && git commit -m "Use MdIcon for NgShop toolbar logo"
----

=== Making products grid list responsive

. In the _home.component.ts_ file import two more classes from @angular/core module - `ChangeDetectorRef` and `OnDestroy`:
+
[source, ts]
----
import {
    ChangeDetectorRef, // <1>
    Component,
    OnDestroy          // <1>
} from '@angular/core';
----
<1> These two lines have been added.

. Add following code to the `HomeComponent` class members, right after `categories` property declaration:
+
[source, ts]
----

/**
 * Keeps the callback function that we pass to the MediaQueryList.addListener() and
 * method MediaQueryList.removeListener(). It must be exactly the same instance of
 * the function to succesfully unsubsribe from notifications and prevent memory leaks.
 */
private mediaQueryListener: MediaQueryListListener;

/**
 * Lists breakpoints defined in the Material Design guidelines, and their corresponding
 * short names. We use names to easier match breakpoint to the current screen size, see
 * method onMediaQueryChange().
 *
 * For the Material Design responsive UI guidelines see:
 * https://material.io/guidelines/layout/responsive-ui.html#responsive-ui-breakpoints.
 */
private readonly mediaQueries: Map<MediaQueryList, string> = new Map([
  [matchMedia('(max-width: 600px)'),                         'xsmall'],
  [matchMedia('(max-width: 960px) and (min-width: 601px)'),  'small'],
  [matchMedia('(max-width: 1280px) and (min-width: 961px)'), 'medium'],
  [matchMedia('(min-width: 1281px)'),                        'large']
]);

columns: number;
----

. Add `ChangeDetectorRef` to constructor's parameters:
+
[source, ts]
----
constructor(
    private changeDetectorRef: ChangeDetectorRef, // <1>
    private productService: ProductService) {
  // Rest of the constructor's body...
}
----
<1> This lines was added.

. Add following code at the end of the constructor's definition, right before closing curly braces:
+
[source, ts]
----
// If we pass this.onMediaQueryChange method directly to the
// MediaQueryList.addListener(), `this` keyword won't reference the current
// component's instance within onMediaQueryChange() body. We need to bind
// onMediaQueryChange() to the current instance using Function.bind().
// However Function.bind() dynamically creates a new instance of the
// function, and we won't be able to remove the listener, since we don't
// have a reference to the function returned by Function.bind(). To fix this
// behavior we save the function in the component's property
// this.mediaQueryListener.
this.mediaQueryListener = this.onMediaQueryChange.bind(this);
this.mediaQueries.forEach((screenSize, mediaQueryList) => {
  mediaQueryList.addListener(this.mediaQueryListener);

  // Set initial number of grid list columns.
  if (mediaQueryList.matches) {
    this.updateGridListColumns(mediaQueryList);
  }
});
----

. Add two following methods at the end of `HomeComponent` class declaration, right before closing curly brace:
+
[source, ts]
----
/**
 * Invoked when one of the breakpoints is triggered.
 */
private onMediaQueryChange(mediaQueryListOrEvent: MediaQueryList|any) {
  // Google Chrome passes an instance of MediaQueryListEvent as the argument,
  // Firefox passes a MediaQueryList instance. Find out what has been passed
  // to make the rest of the method's code cross-browser compatible.
  const mql: MediaQueryList = 'target' in mediaQueryListOrEvent ?
    mediaQueryListOrEvent.target :
    mediaQueryListOrEvent;

  if (mql.matches) {
    this.updateGridListColumns(mql);

    // Currently zone.js doesn't patch the MediaQueryList API, this means
    // the Angular change detection mechanism is not automatically triggered
    // when a MediaQueryListener finishes its work. So we need to trigger the
    // change detector manually.
    //
    // For zone.js issue see: https://github.com/angular/zone.js/issues/243
    this.changeDetectorRef.detectChanges();
  }
}

/**
 * Adjusts number of grid list columns when the screen size changes.
 */
private updateGridListColumns(mediaQueryList: MediaQueryList) {
  switch (this.mediaQueries.get(mediaQueryList)) {
    case 'xsmall': this.columns = 1; break;
    case 'small': this.columns = 2; break;
    case 'medium':
    case 'large': this.columns = 3; break;
  }
}
----

. Implement `OnDestroy` interface for `HomeComponent` class. Add following implementation for the mandatory `ngOnDestroy()` method:
+
[source, ts]
----
export class HomeComponent implements OnDestroy {
  // Rest of the class declaration...

  ngOnDestroy() {
    this.mediaQueries.forEach((screenSize, mediaQueryList) => {
      mediaQueryList.removeListener(this.mediaQueryListener);
    });
  }
}
----

. Now bind `MdGridList`{nbsp}'s `cols` property to the `HomeComponent`{nbsp}'s `columns` property in the _home.component.html_ template:
+
[source, html]
----
<md-grid-list
    [cols]="columns" <!--1-->
    gutterSize="16">
  <!-- Tiles declaration... -->
</md-grid-list>
----
<1> This property binding was added.

. Open the application in a web browser. On wide screens you should see 3 columns as shown on <<figure-8,Figure 8>>. But if you start narrowing the window, layout will first switch to 2 columns and then all of the products will be vertically aligned in a single column:
+
.Products grid layout on narrow screens
image::fig_10.jpg[Products grid layout on narrow screens]

. Commit the changes to save the progress:
+
[source, shell]
----
$ git add -A && git commit -m "Make products grid responsive"
----
